// Generated by CoffeeScript 1.7.1
(function() {
  var $addPerDiem, checkAmount, disableSaveButton, hoursCheck, idIteratorValue, isHadChild, perDiemWrapper, validationOfGreaterThan0, validationOfHoursCompare,
    __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

  perDiemWrapper = '';

  idIteratorValue = 0;

  isHadChild = false;

  $addPerDiem = $('#addPerDiem');

  $addPerDiem.click(function(event) {
    var clonedPerDiemWrapper;
    event.preventDefault();
    clonedPerDiemWrapper = perDiemWrapper;
    idIteratorValue++;
    clonedPerDiemWrapper = clonedPerDiemWrapper.replace(/__index__/g, idIteratorValue);
    return $('.container').append(clonedPerDiemWrapper);
  });

  $('.container').on('click', '.deletePerDiem', function() {
    return $(this).parent().parent().remove();
  });

  validationOfHoursCompare = function() {
    var hoursArray, isUnique;
    isUnique = true;
    hoursArray = [];
    $('.hours').each(function(index) {
      var _ref;
      if (_ref = $(this).val(), __indexOf.call(hoursArray, _ref) >= 0) {
        return isUnique = false;
      } else {
        return hoursArray.push($(this).val());
      }
    });
    return isUnique;
  };

  validationOfGreaterThan0 = function(valueOfAmount) {
    var isGreaterThan0;
    isGreaterThan0 = true;
    if (0 >= valueOfAmount) {
      isGreaterThan0 = false;
    }
    return isGreaterThan0;
  };

  hoursCheck = function(hoursElement) {
    var $wrapper, errorMessage, hours, isUnique;
    isUnique = validationOfHoursCompare();
    $wrapper = hoursElement.parent();
    if (!isUnique) {
      if ($wrapper.children('label.custom-label-error').length === 0) {
        errorMessage = $('<label>').html('The value of hours should be unique value!').addClass('custom-label-error');
        $wrapper.prepend('<br />');
        $wrapper.prepend(errorMessage);
        disableSaveButton(true);
      }
      return false;
    } else {
      hours = $('form').find('.hours');
      hours.each(function(index) {
        $wrapper = $(this).parent();
        $wrapper.children('label.custom-label-error').remove();
        $wrapper.children('br').remove();
        return disableSaveButton(false);
      });
      return true;
    }
  };

  $(".container").on("keyup", ".hours", function() {
    return hoursCheck($(this));
  });

  $(".container").on("change", ".hours", function() {
    return hoursCheck($(this));
  });

  checkAmount = function(amountElement) {
    var isGreaterThan0;
    isGreaterThan0 = validationOfGreaterThan0(amountElement);
    if (!isGreaterThan0) {
      return false;
    } else {
      return true;
    }
  };

  disableSaveButton = function(disable) {
    if (disable === true) {
      return $('#save').attr('disabled', true);
    } else {
      return $('#save').removeAttr('disabled');
    }
  };

  $(document).ready(function() {
    idIteratorValue = $('.formFieldsetChild').length;
    isHadChild = $('.container').children('.formFieldsetChild').length > 0;
    $.ajax({
      method: 'GET',
      url: Routing.generate('OpitNotesUserBundle_admin_show_perdiem')
    }).done(function(data) {
      perDiemWrapper = data;
    });
  });

  $.validator.addMethod('checkAmount', function(value, element) {
    return checkAmount(value);
  }, 'The Amount should be greater than 0!');

  $.validator.addClassRules('amount', {
    checkAmount: {
      elements: ".amount"
    }
  });

  $('#save').click(function(event) {
    var form, isHasChild;
    event.preventDefault();
    form = $('form');
    isHasChild = $('.container').children('.formFieldsetChild').length > 0;
    if (form.valid() && validationOfHoursCompare() && (isHasChild || isHadChild)) {
      disableSaveButton(true);
      $.ajax({
        method: 'POST',
        data: form.serialize(),
        dataType: 'json',
        url: Routing.generate('OpitNotesUserBundle_admin_save_perdiem')
      }).done(function(data) {
        var response;
        disableSaveButton(false);
        response = data;
        $.ajax({
          type: 'POST',
          url: Routing.generate('OpitNotesUserBundle_admin_list_perdiem'),
          data: {
            "showList": 1
          }
        }).done(function(data) {
          $('.container').html(data);
          $(document).data('notes').funcs.showAlert(response, "create", "Per diems saved successfully!");
          return isHadChild = $('.container').children('.formFieldsetChild').length > 0;
        }).fail(function(data) {
          return $(document).data('notes').funcs.showAlert(response, "create", "Error", true);
        });
      }).fail(function(data) {
        return $(document).data('notes').funcs.showAlert(response, "create", "Error", true);
      });
      return;
    } else {
      disableSaveButton(false);
    }
  });

}).call(this);
