// Generated by CoffeeScript 1.7.1
(function() {
  $.extend(true, $(document).data('notes'), {
    funcs: {
      disableStatusDropdown: function($self) {
        var $spinner;
        $spinner = $('<i>').addClass('fa fa-spinner fa-spin');
        $self.parent().append($spinner);
        $self.addClass('dropdown-disabled');
        return $spinner;
      },
      enableStatusDropdown: function($self) {
        $self.parent().find('.fa-spinner').remove();
        $self.prop('selectedIndex', 0);
        return $self.removeClass('dropdown-disabled');
      },
      changeStateDialog: function($dropdown, callback, travelId) {
        return $('<div></div>').html("Change the status of travel from '" + ($dropdown.find('option:nth-child(1)').text().toLowerCase()) + "' to '" + ($dropdown.find('option:selected').text().toLowerCase()) + "' ?").dialog({
          title: '<i class="fa fa-exclamation-triangle"></i> Travel status change',
          buttons: {
            Yes: function() {
              $(this).dialog('destroy');
              return callback($dropdown.val(), travelId, $(document).data('notes').funcs.disableStatusDropdown($dropdown));
            },
            No: function() {
              $(this).dialog('destroy');
              return $(document).data('notes').funcs.enableStatusDropdown($dropdown);
            }
          },
          close: function() {
            $(this).dialog('destroy');
            return $(document).data('notes').funcs.enableStatusDropdown($dropdown);
          }
        });
      },
      changeTravelExpenseStatus: function(statusId, travelExpenseId, $spinner) {
        return $.ajax({
          method: 'POST',
          url: Routing.generate('OpitNotesTravelBundle_expense_state'),
          data: {
            'statusId': statusId,
            'travelExpenseId': travelExpenseId
          }
        }).done(function(data) {
          return location.reload();
        }).complete(function() {
          return $spinner.remove();
        }).fail(function(data) {
          var $changeState;
          $spinner.remove();
          $changeState = $('.changeState[data-tr="' + travelExpenseId + '"]').removeClass('dropdown-disabled').prop('selectedIndex', 0);
          return $('<div id="dialog-tr-error"></div>').html('Status could not be changed due to an error.').dialog({
            title: '<i class="fa fa-exclamation-triangle"></i> An error occurred',
            width: 550,
            buttons: {
              Close: function() {
                $(this).dialog('destroy');
              }
            }
          });
        });
      },
      changeTravelRequestStatus: function(statusId, travelRequestId, $spinner) {
        var $dropDown, $row, reloadPage;
        if ($spinner === void 0) {
          $row = $('tr').find("[data-tr-id=" + travelRequestId + "]");
          $dropDown = $row.closest('tr').find('.changeState');
          $spinner = $(document).data('notes').funcs.disableStatusDropdown($dropDown);
        }
        reloadPage = false;
        return $.ajax({
          method: 'POST',
          url: Routing.generate('OpitNotesTravelBundle_request_state'),
          data: {
            'statusId': statusId,
            'travelRequestId': travelRequestId
          }
        }).done(function(data) {
          if (data === 'error') {
            return $('<div id="dialog-tr-error"></div>').html('You cannot change the status of the travel request because it has been already changed.').dialog({
              title: '<i class="fa fa-exclamation-triangle"></i> Status cannot be changed',
              width: 550,
              buttons: {
                Reload: function() {
                  location.reload();
                }
              }
            });
          } else {
            return reloadPage = true;
          }
        }).complete(function() {
          $spinner.remove();
          if (reloadPage === true) {
            return location.reload();
          }
        }).fail(function(data) {
          var $changeState;
          $spinner.remove();
          $changeState = $('.changeState[data-tr="' + travelRequestId + '"]').removeClass('dropdown-disabled').prop('selectedIndex', 0);
          return $('<div id="dialog-tr-error"></div>').html('Status could not be changed due to an error.').dialog({
            title: '<i class="fa fa-exclamation-triangle"></i> An error occurred',
            width: 550,
            buttons: {
              Close: function() {
                $(this).dialog('destroy');
              }
            }
          });
        });
      },
      showTravelStatusHistory: function(id, mode) {
        return $.ajax({
          method: 'POST',
          url: Routing.generate('OpitNotesTravelBundle_travel_states_history', {
            mode: mode
          }),
          data: {
            'id': id
          }
        }).done(function(data) {
          $('<div id="dialog-show-details-tr"></div>').html(data).dialog({
            title: '<i class="fa fa-book"></i> Status history',
            width: 550,
            maxHeight: $(window).outerHeight() - 100,
            modal: true,
            buttons: {
              Close: function() {
                $('#dialog-show-details-tr').dialog('destroy');
              }
            }
          });
        });
      }
    }
  });

}).call(this);
